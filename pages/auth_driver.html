<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Driver Authentication - RideSync Pro</title>
    <link rel="stylesheet" href="../css/main.css" />
    <meta name="description" content="Sign in or create an account to access RideSync Pro driver features." />
</head>
<body class="bg-surface">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-soft border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <svg class="w-8 h-8 text-primary mr-3" viewBox="0 0 32 32" fill="currentColor">
                        <path d="M16 2L4 8v16l12 6 12-6V8L16 2zm0 2.5L25.5 9 16 13.5 6.5 9 16 4.5zM6 10.5l9 4.5v11l-9-4.5v-11zm11 16v-11l9-4.5v11L17 26.5z"/>
                    </svg>
                    <span class="text-xl font-bold text-slate-900">RideSync Pro</span>
                </div>
                
                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="smart_landing_page.html" class="text-slate-600 hover:text-primary transition-quick">Home</a>
                    <a href="auth_rider.html" class="text-slate-600 hover:text-primary transition-quick">Rider Portal</a>
                    <a href="auth_driver.html" class="text-primary font-medium">Driver Portal</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Authentication Section -->
    <section class="py-20 bg-gradient-to-br from-primary-50 via-white to-accent-50">
        <div class="max-w-md mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-2xl shadow-focus p-8 border border-slate-200">
                <!-- Logo and Title -->
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center mb-4">
                        <svg class="w-10 h-10 text-primary mr-3" viewBox="0 0 32 32" fill="currentColor">
                            <path d="M16 2L4 8v16l12 6 12-6V8L16 2zm0 2.5L25.5 9 16 13.5 6.5 9 16 4.5zM6 10.5l9 4.5v11l-9-4.5v-11zm11 16v-11l9-4.5v11L17 26.5z"/>
                        </svg>
                        <span class="text-2xl font-bold text-slate-900">RideSync Pro</span>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-900">Driver Authentication</h1>
                    <p class="text-slate-600 mt-2">Sign in or apply to become a driver partner</p>
                </div>
                
                <!-- Tabs for Login/Signup -->
                <div class="flex border-b border-slate-200 mb-6">
                    <button id="login-tab" class="flex-1 py-3 text-center font-medium border-b-2 border-primary text-primary">Login</button>
                    <button id="signup-tab" class="flex-1 py-3 text-center font-medium text-slate-500 hover:text-slate-700">Apply Now</button>
                </div>
                
                <!-- Login Form -->
                <form id="login-form" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="Enter your email" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                        <input type="password" id="login-password" class="input-field" placeholder="Enter your password" required />
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" id="remember-me">
                            <label for="remember-me" class="ml-2 text-sm text-slate-600">Remember me</label>
                        </div>
                        <a href="javascript:void(0)" class="text-sm text-primary hover:text-primary-700">Forgot password?</a>
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">Login to Driver Portal</button>
                </form>
                
                <!-- Signup Form (Hidden by default) -->
                <form id="signup-form" class="space-y-5 hidden">
                    <div class="bg-accent-50 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-slate-900 mb-2">Driver Application Requirements</h3>
                        <ul class="text-sm text-slate-600 space-y-1">
                            <li>• Valid driver's license</li>
                            <li>• Clean driving record</li>
                            <li>• Vehicle insurance</li>
                            <li>• Background check clearance</li>
                        </ul>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">First Name</label>
                            <input type="text" id="first-name" class="input-field" placeholder="First name" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Last Name</label>
                            <input type="text" id="last-name" class="input-field" placeholder="Last name" required />
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Email Address</label>
                        <input type="email" id="signup-email" class="input-field" placeholder="Enter your email" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Phone Number</label>
                        <input type="tel" id="phone-number" class="input-field" placeholder="Enter your phone number" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Driver's License Number</label>
                        <input type="text" id="license-number" class="input-field" placeholder="Enter license number" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Vehicle Type</label>
                        <select id="vehicle-type" class="input-field" required>
                            <option value="">Select vehicle type</option>
                            <option value="sedan">Sedan</option>
                            <option value="suv">SUV</option>
                            <option value="luxury">Luxury</option>
                            <option value="van">Van</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Vehicle Year</label>
                        <input type="number" id="vehicle-year" class="input-field" placeholder="e.g., 2020" min="2010" max="2025" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                        <input type="password" id="signup-password" class="input-field" placeholder="Create a password" required />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Confirm Password</label>
                        <input type="password" id="confirm-password" class="input-field" placeholder="Confirm your password" required />
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" id="terms" required>
                        <label for="terms" class="ml-2 text-sm text-slate-600">
                            I agree to the <a href="javascript:void(0)" class="text-primary hover:text-primary-700">Driver Agreement</a> and <a href="javascript:void(0)" class="text-primary hover:text-primary-700">Privacy Policy</a>
                        </label>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" id="background-check" required>
                        <label for="background-check" class="ml-2 text-sm text-slate-600">
                            I consent to a background check as part of the application process
                        </label>
                    </div>
                    
                    <button type="submit" class="btn-primary w-full">Send OTP Verification</button>
                </form>
                
                <!-- OTP Verification (Hidden by default) -->
                <div id="otp-verification" class="space-y-5 hidden">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-slate-900">Verify Your Account</h3>
                        <p class="text-slate-600 mt-2">We've sent a verification code to your email</p>
                        <p class="text-sm text-slate-500 mt-1" id="otp-email-display"></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Enter Verification Code</label>
                        <div class="flex space-x-3">
                            <input type="text" maxlength="1" class="input-field text-center text-lg font-semibold otp-input" pattern="[0-9]" required>
                            <input type="text" maxlength="1" class="input-field text-center text-lg font-semibold otp-input" pattern="[0-9]" required>
                            <input type="text" maxlength="1" class="input-field text-center text-lg font-semibold otp-input" pattern="[0-9]" required>
                            <input type="text" maxlength="1" class="input-field text-center text-lg font-semibold otp-input" pattern="[0-9]" required>
                            <input type="text" maxlength="1" class="input-field text-center text-lg font-semibold otp-input" pattern="[0-9]" required>
                            <input type="text" maxlength="1" class="input-field text-center text-lg font-semibold otp-input" pattern="[0-9]" required>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-sm text-slate-600">Didn't receive the code? <a href="javascript:void(0)" id="resend-otp" class="text-primary hover:text-primary-700">Resend</a></p>
                    </div>
                    
                    <button type="button" id="verify-otp" class="btn-primary w-full">Verify & Create Account</button>
                </div>
                
                <!-- Messages -->
                <div id="message-container" class="hidden mt-4 p-4 rounded-lg"></div>
            </div>
        </div>
    </section>

    <script>
        const API_BASE_URL = 'http://localhost:5000/apiproject-production-bcbe.up.railway.appproject-production-bcbe.up.railway.app';

        // DOM Elements
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const otpVerification = document.getElementById('otp-verification');
        const messageContainer = document.getElementById('message-container');
        const verifyOtpBtn = document.getElementById('verify-otp');
        const resendOtpBtn = document.getElementById('resend-otp');
        const otpEmailDisplay = document.getElementById('otp-email-display');

        let currentUserData = null;

        function showMessage(message, type = 'error') {
            messageContainer.className = `mt-4 p-4 rounded-lg ${
                type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 
                'bg-green-50 text-green-700 border border-green-200'
            }`;
            messageContainer.textContent = message;
            messageContainer.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    messageContainer.classList.add('hidden');
                }, 5000);
            }
        }

        // Tab switching
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('border-primary', 'text-primary');
            signupTab.classList.remove('border-primary', 'text-primary');
            signupTab.classList.add('text-slate-500');
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            otpVerification.classList.add('hidden');
            messageContainer.classList.add('hidden');
        });
        
        signupTab.addEventListener('click', () => {
            signupTab.classList.add('border-primary', 'text-primary');
            loginTab.classList.remove('border-primary', 'text-primary');
            loginTab.classList.add('text-slate-500');
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            otpVerification.classList.add('hidden');
            messageContainer.classList.add('hidden');
        });

        // OTP input navigation
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && index > 0 && e.target.value === '') {
                    otpInputs[index - 1].focus();
                }
            });
        });

        // Signup form submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const email = document.getElementById('signup-email').value;
            
            if (password !== confirmPassword) {
                showMessage('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long');
                return;
            }

            currentUserData = {
                firstName: document.getElementById('first-name').value,
                lastName: document.getElementById('last-name').value,
                email: email,
                phoneNumber: document.getElementById('phone-number').value,
                password: password,
                userType: 'driver',
                driverProfile: {
                    licenseNumber: document.getElementById('license-number').value,
                    vehicleType: document.getElementById('vehicle-type').value,
                    vehicleYear: parseInt(document.getElementById('vehicle-year').value)
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: currentUserData.email,
                        phoneNumber: currentUserData.phoneNumber,
                        userType: 'driver',
                        userData: currentUserData
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('OTP sent successfully! Check your email for the verification code.', 'success');
                    otpEmailDisplay.textContent = currentUserData.email;
                    signupForm.classList.add('hidden');
                    otpVerification.classList.remove('hidden');
                } else {
                    showMessage(data.message || 'Error sending OTP');
                }
            } catch (error) {
                console.error('OTP send error:', error);
                showMessage('Network error. Please try again.');
            }
        });

        // Verify OTP
        verifyOtpBtn.addEventListener('click', async () => {
            const otpInputs = document.querySelectorAll('.otp-input');
            const otp = Array.from(otpInputs).map(input => input.value).join('');
            
            if (otp.length !== 6) {
                showMessage('Please enter the complete 6-digit OTP');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: currentUserData.email,
                        otp: otp,
                        userType: 'driver'
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('Account created successfully! Redirecting...', 'success');
                    
                    // Store token and user data
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    setTimeout(() => {
                        window.location.href = 'driver_dashboard.html';
                    }, 2000);
                } else {
                    showMessage(data.message || 'Invalid OTP');
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                showMessage('Network error. Please try again.');
            }
        });

        // Resend OTP
        resendOtpBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: currentUserData.email,
                        phoneNumber: currentUserData.phoneNumber,
                        userType: 'driver',
                        userData: currentUserData
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('New OTP sent! Check your email for the verification code.', 'success');
                } else {
                    showMessage(data.message || 'Error resending OTP');
                }
            } catch (error) {
                console.error('Resend OTP error:', error);
                showMessage('Network error. Please try again.');
            }
        });

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const loginData = {
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value,
                userType: 'driver'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(loginData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    showMessage('Login successful! Redirecting...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'driver_dashboard.html';
                    }, 1000);
                } else {
                    showMessage(data.message || 'Invalid email or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Network error. Please try again.');
            }
        });
    </script>
</body>
</html>